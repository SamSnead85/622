generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                         String                    @id @default(uuid())
  email                      String                    @unique
  phone                      String?                   @unique
  username                   String                    @unique
  displayName                String
  displayNameSecondary       String?
  secondaryLanguage          String?
  bio                        String?
  website                    String?
  avatarUrl                  String?
  coverUrl                   String?
  passwordHash               String?
  role                       Role                      @default(USER)
  isVerified                 Boolean                   @default(false)
  isPrivate                  Boolean                   @default(false)
  isGroupOnly                Boolean                   @default(false)
  primaryCommunityId         String?
  isBanned                   Boolean                   @default(false)
  lastActiveAt               DateTime                  @default(now())
  createdAt                  DateTime                  @default(now())
  updatedAt                  DateTime                  @updatedAt
  resetToken                 String?
  resetTokenExpiry           DateTime?
  twoFactorEnabled           Boolean                   @default(false)
  twoFactorSecret            String?
  twoFactorBackupCodes       String[]
  twoFactorVerifiedAt        DateTime?
  bulletinPosts              BulletinPost[]
  comments                   Comment[]
  createdCommunities         Community[]               @relation("CommunityCreator")
  communityMemberships       CommunityMember[]
  receivedConnectionRequests ConnectionRequest[]       @relation("ReceivedConnectionRequests")
  sentConnectionRequests     ConnectionRequest[]       @relation("SentConnectionRequests")
  conversations              ConversationParticipant[]
  following                  Follow[]                  @relation("Followers")
  followers                  Follow[]                  @relation("Following")
  joinedViaInvite            Invite?                   @relation("JoinedViaInvite")
  sentInvites                Invite[]                  @relation("SentInvites")
  likes                      Like[]
  liveStreams                LiveStream[]
  liveStreamChats            LiveStreamChat[]
  streamSuggestions          LiveStreamSuggestion[]
  sentMessages               Message[]                 @relation("MessageSender")
  migrations                 Migration[]
  moments                    Moment[]
  momentViews                MomentView[]
  notifications              Notification[]
  oauthAccounts              OAuthAccount[]
  matchedConnections         PendingConnection[]       @relation("MatchedConnections")
  importedConnections        PendingConnection[]       @relation("ImportedConnections")
  posts                      Post[]
  rsvps                      PostRSVP[]
  reports                    Report[]
  saves                      Save[]
  sessions                   Session[]
  shares                     Share[]
  subscription               Subscription?
  twoFactorChallenges        TwoFactorChallenge[]
  connectionSettings         UserConnectionSettings?
  interests                  UserInterest[]
  presence                   UserPresence?
  keyBundle                  UserKeyBundle?
  scheduledPosts             ScheduledPost[]
  feedPreferences            UserFeedPreferences?
  proposals                  Proposal[]
  notificationPrefs          NotificationPreferences?
  pushSubscriptions          PushSubscription[]

  @@index([username])
  @@index([email])
}

model Session {
  id         String   @id @default(uuid())
  userId     String
  token      String   @unique
  deviceType String?
  deviceName String?
  ipAddress  String?
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model TwoFactorChallenge {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

model OAuthAccount {
  id           String   @id @default(uuid())
  userId       String
  provider     String
  providerId   String
  accessToken  String?
  refreshToken String?
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerId])
  @@index([userId])
}

model Moment {
  id           String       @id @default(uuid())
  userId       String
  type         MomentType   @default(IMAGE)
  mediaUrl     String
  thumbnailUrl String?
  duration     Int?
  caption      String?
  musicId      String?
  viewCount    Int          @default(0)
  expiresAt    DateTime
  isActive     Boolean      @default(true)
  createdAt    DateTime     @default(now())
  music        Music?       @relation(fields: [musicId], references: [id])
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  views        MomentView[]

  @@index([userId])
  @@index([expiresAt])
  @@index([createdAt])
}

model MomentView {
  id       String   @id @default(uuid())
  momentId String
  userId   String
  viewedAt DateTime @default(now())
  moment   Moment   @relation(fields: [momentId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([momentId, userId])
  @@index([momentId])
  @@index([userId])
}

model LiveStream {
  id              String           @id @default(uuid())
  userId          String
  title           String
  description     String?
  thumbnailUrl    String?
  streamKey       String           @unique @default(uuid())
  playbackUrl     String?
  status          LiveStreamStatus @default(SCHEDULED)
  viewerCount     Int              @default(0)
  peakViewerCount Int              @default(0)
  totalViews      Int              @default(0)
  startedAt       DateTime?
  endedAt         DateTime?
  scheduledFor    DateTime?
  muxStreamId     String?          @unique
  muxPlaybackId   String?
  muxAssetId      String?
  category        String?
  tags            String[]         @default([])
  isRecorded      Boolean          @default(true)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  chatMessages    LiveStreamChat[]

  @@index([userId])
  @@index([status])
  @@index([startedAt])
  @@index([category])
  @@index([muxStreamId])
}

model LiveStreamChat {
  id         String     @id @default(uuid())
  streamId   String
  userId     String
  content    String
  type       ChatType   @default(MESSAGE)
  giftType   String?
  giftAmount Int?
  createdAt  DateTime   @default(now())
  stream     LiveStream @relation(fields: [streamId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([streamId])
  @@index([userId])
  @@index([createdAt])
}

model Follow {
  id          String   @id @default(uuid())
  followerId  String
  followingId String
  createdAt   DateTime @default(now())
  follower    User     @relation("Followers", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("Following", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

model Post {
  id           String        @id @default(uuid())
  userId       String
  communityId  String?
  type         PostType      @default(VIDEO)
  caption      String?
  mediaUrl     String?
  thumbnailUrl String?
  duration     Int?
  musicId      String?
  viewCount    Int           @default(0)
  isPublic     Boolean       @default(true)
  isPinned     Boolean       @default(false)
  deletedAt    DateTime?     // Soft delete support
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  comments     Comment[]
  likes        Like[]
  community    Community?    @relation(fields: [communityId], references: [id], onDelete: SetNull)
  music        Music?        @relation(fields: [musicId], references: [id], onDelete: SetNull)
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  hashtags     PostHashtag[]
  rsvps        PostRSVP[]
  topics       PostTopic[]
  saves        Save[]
  shares       Share[]
  analytics    PostAnalytics[]

  @@index([userId])
  @@index([communityId])
  @@index([createdAt])
  @@index([isPublic, createdAt(sort: Desc), isPinned]) // Feed query optimization
  @@index([isPublic, isPinned, createdAt(sort: Desc)]) // Feed ranking optimization
  @@index([deletedAt]) // Soft delete filter
}

model Music {
  id         String   @id @default(uuid())
  title      String
  artist     String
  audioUrl   String
  duration   Int
  coverUrl   String?
  usageCount Int      @default(0)
  createdAt  DateTime @default(now())
  moments    Moment[]
  posts      Post[]

  @@index([title])
  @@index([artist])
}

model Comment {
  id         String    @id @default(uuid())
  postId     String
  userId     String
  parentId   String?
  content    String
  likesCount Int       @default(0)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  parent     Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies    Comment[] @relation("CommentReplies")
  post       Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([userId])
  @@index([parentId])
  @@index([postId, parentId, createdAt(sort: Desc)]) // Thread queries optimization
}

model Like {
  id        String   @id @default(uuid())
  userId    String
  postId    String
  createdAt DateTime @default(now())
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([postId])
  @@index([userId]) // User's liked posts optimization
}

model Share {
  id        String   @id @default(uuid())
  userId    String
  postId    String
  createdAt DateTime @default(now())
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([postId])
}

model Save {
  id        String   @id @default(uuid())
  userId    String
  postId    String
  createdAt DateTime @default(now())
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([userId])
}

model PostRSVP {
  id        String     @id @default(uuid())
  postId    String
  userId    String
  status    RSVPStatus @default(IN)
  createdAt DateTime   @default(now())
  post      Post       @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([postId])
}

model Hashtag {
  id         String        @id @default(uuid())
  name       String        @unique
  usageCount Int           @default(0)
  createdAt  DateTime      @default(now())
  posts      PostHashtag[]

  @@index([name])
}

model PostHashtag {
  id        String  @id @default(uuid())
  postId    String
  hashtagId String
  hashtag   Hashtag @relation(fields: [hashtagId], references: [id], onDelete: Cascade)
  post      Post    @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([postId, hashtagId])
}

model Community {
  id          String            @id @default(uuid())
  creatorId   String
  name        String            @unique
  slug        String            @unique
  description String?
  avatarUrl   String?
  coverUrl    String?
  isPublic    Boolean           @default(true)
  memberCount Int               @default(0)
  postCount   Int               @default(0)
  // Branding fields for custom group identity
  brandColor  String?           // Hex color e.g. "#FF6B35"
  tagline     String?           // Short invite tagline e.g. "The Smith Family Circle"
  logoUrl     String?           // Custom group logo/icon image
  category    String?           // family, friends, business, faith, hobby, local
  websiteUrl  String?           // Group website URL
  // Admin configuration
  approvalRequired Boolean      @default(false)
  postingPermission String      @default("all")      // "all" | "admins_mods" | "admins_only"
  invitePermission  String      @default("all")      // "all" | "admins_mods" | "admins_only"
  isAnnouncementOnly Boolean    @default(false)       // Only admins/mods can post
  welcomeMessage    String?                            // Auto-sent to new members
  pinnedMessageId   String?                            // Pinned post ID
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  creator        User              @relation("CommunityCreator", fields: [creatorId], references: [id])
  members        CommunityMember[]
  rules          CommunityRule[]
  posts          Post[]
  proposals      Proposal[]
  moderationLogs ModerationLog[]

  @@index([name])
  @@index([slug])
}

model Proposal {
  id            String         @id @default(uuid())
  communityId   String
  authorId      String
  title         String
  description   String
  type          ProposalType
  status        ProposalStatus @default(ACTIVE)
  targetData    Json?
  votesFor      Int            @default(0)
  votesAgainst  Int            @default(0)
  quorum        Int            @default(10)
  expiresAt     DateTime
  resolvedAt    DateTime?
  createdAt     DateTime       @default(now())
  community     Community      @relation(fields: [communityId], references: [id], onDelete: Cascade)
  author        User           @relation(fields: [authorId], references: [id])
  votes         ProposalVote[]

  @@index([communityId, status])
}

model ProposalVote {
  id         String   @id @default(uuid())
  proposalId String
  userId     String
  vote       Boolean
  createdAt  DateTime @default(now())
  proposal   Proposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)

  @@unique([proposalId, userId])
  @@index([userId])
}

model ModerationLog {
  id          String    @id @default(uuid())
  communityId String
  moderatorId String
  action      String
  targetType  String
  targetId    String
  reason      String?
  createdAt   DateTime  @default(now())
  community   Community @relation(fields: [communityId], references: [id], onDelete: Cascade)

  @@index([communityId, createdAt])
  @@index([moderatorId])
}

model CommunityMember {
  id          String        @id @default(uuid())
  userId      String
  communityId String
  role        CommunityRole @default(MEMBER)
  isMuted     Boolean       @default(false)
  isBanned    Boolean       @default(false)
  nickname    String?
  joinedAt    DateTime      @default(now())
  community   Community     @relation(fields: [communityId], references: [id], onDelete: Cascade)
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, communityId])
  @@index([communityId])
}

model CommunityRule {
  id          String    @id @default(uuid())
  communityId String
  title       String
  description String
  order       Int       @default(0)
  createdAt   DateTime  @default(now())
  community   Community @relation(fields: [communityId], references: [id], onDelete: Cascade)

  @@index([communityId])
}

model Conversation {
  id           String                    @id @default(uuid())
  isGroup      Boolean                   @default(false)
  groupName    String?
  groupAvatar  String?
  communityId  String?                   // Link to community for group chat
  createdAt    DateTime                  @default(now())
  updatedAt    DateTime                  @updatedAt
  participants ConversationParticipant[]
  messages     Message[]

  @@index([communityId])
}

model ConversationParticipant {
  id             String       @id @default(uuid())
  conversationId String
  userId         String
  lastReadAt     DateTime     @default(now())
  isMuted        Boolean      @default(false)
  joinedAt       DateTime     @default(now())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([userId])
}

model Message {
  id             String        @id @default(uuid())
  conversationId String
  senderId       String
  content        String
  mediaUrl       String?
  mediaType      MessageMedia?
  isEdited       Boolean       @default(false)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  conversation   Conversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender         User          @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  type      NotificationType
  actorId   String?
  targetId  String?
  message   String
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@index([userId, isRead, createdAt(sort: Desc)]) // Unread notifications query
  @@index([actorId]) // Actor lookup optimization
}

// ============================================
// CHECK-IN / STATUS
// ============================================
model MemberStatus {
  id          String   @id @default(uuid())
  userId      String
  communityId String
  emoji       String   @default("ðŸ‘‹")
  text        String?
  expiresAt   DateTime?
  createdAt   DateTime @default(now())

  @@unique([userId, communityId])
  @@index([communityId])
}

// ============================================
// GROUP POLLS
// ============================================
model Poll {
  id          String       @id @default(uuid())
  communityId String
  creatorId   String
  question    String
  isAnonymous Boolean      @default(false)
  allowMultiple Boolean    @default(false)
  expiresAt   DateTime?
  createdAt   DateTime     @default(now())
  options     PollOption[]
  votes       PollVote[]

  @@index([communityId])
  @@index([creatorId])
}

model PollOption {
  id     String     @id @default(uuid())
  pollId String
  text   String
  order  Int        @default(0)
  poll   Poll       @relation(fields: [pollId], references: [id], onDelete: Cascade)
  votes  PollVote[]

  @@index([pollId])
}

model PollVote {
  id       String     @id @default(uuid())
  pollId   String
  optionId String
  userId   String
  votedAt  DateTime   @default(now())
  poll     Poll       @relation(fields: [pollId], references: [id], onDelete: Cascade)
  option   PollOption @relation(fields: [optionId], references: [id], onDelete: Cascade)

  @@unique([pollId, optionId, userId])
  @@index([pollId])
}

// ============================================
// SHARED PHOTO ALBUMS
// ============================================
model Album {
  id          String       @id @default(uuid())
  communityId String
  creatorId   String
  title       String
  description String?
  coverUrl    String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  photos      AlbumPhoto[]

  @@index([communityId])
}

model AlbumPhoto {
  id        String   @id @default(uuid())
  albumId   String
  userId    String
  url       String
  caption   String?
  createdAt DateTime @default(now())
  album     Album    @relation(fields: [albumId], references: [id], onDelete: Cascade)

  @@index([albumId])
}

// ============================================
// CALL LOG
// ============================================
model CallLog {
  id         String   @id @default(uuid())
  callerId   String
  receiverId String?
  communityId String?
  callType   String   @default("audio")  // "audio" | "video"
  status     String   @default("initiated") // "initiated" | "ringing" | "answered" | "ended" | "missed" | "rejected"
  duration   Int?     // seconds
  startedAt  DateTime @default(now())
  endedAt    DateTime?

  @@index([callerId])
  @@index([receiverId])
}

model Migration {
  id                 String              @id @default(uuid())
  userId             String
  platform           MigrationPlatform
  status             MigrationStatus     @default(PENDING)
  filePath           String?
  stats              Json?
  errorMessage       String?
  createdAt          DateTime            @default(now())
  startedAt          DateTime?
  completedAt        DateTime?
  importedPosts      ImportedPost[]
  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  pendingConnections PendingConnection[]

  @@index([userId])
  @@index([status])
}

model ImportedPost {
  id                String       @id @default(uuid())
  migrationId       String
  originalPlatform  String
  originalId        String?
  originalTimestamp DateTime?
  type              PostType     @default(IMAGE)
  caption           String?
  mediaUrls         String[]
  location          String?
  tags              String[]
  importStatus      ImportStatus @default(PENDING)
  caravanPostId     String?
  errorMessage      String?
  createdAt         DateTime     @default(now())
  migration         Migration    @relation(fields: [migrationId], references: [id], onDelete: Cascade)

  @@index([migrationId])
  @@index([importStatus])
}

model PendingConnection {
  id               String            @id @default(uuid())
  userId           String
  migrationId      String?
  platform         MigrationPlatform
  originalUsername String
  displayName      String?
  profileImageUrl  String?
  email            String?
  phone            String?
  matchedUserId    String?
  matchConfidence  Int?
  connectionType   ConnectionType    @default(FOLLOWER)
  inviteStatus     InviteStatus      @default(NOT_SENT)
  inviteSentAt     DateTime?
  inviteMethod     InviteMethod?
  createdAt        DateTime          @default(now())
  matchedUser      User?             @relation("MatchedConnections", fields: [matchedUserId], references: [id])
  migration        Migration?        @relation(fields: [migrationId], references: [id])
  user             User              @relation("ImportedConnections", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([inviteStatus])
  @@index([originalUsername])
}

model Invite {
  id             String       @id @default(uuid())
  senderId       String
  recipientEmail String?
  recipientPhone String?
  method         InviteMethod
  status         InviteStatus @default(SENT)
  referralCode   String       @unique
  message        String?
  createdAt      DateTime     @default(now())
  sentAt         DateTime     @default(now())
  openedAt       DateTime?
  joinedAt       DateTime?
  joinedUserId   String?      @unique
  joinedUser     User?        @relation("JoinedViaInvite", fields: [joinedUserId], references: [id])
  sender         User         @relation("SentInvites", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([senderId])
  @@index([referralCode])
  @@index([status])
}

model Territory {
  id                        String                      @id @default(uuid())
  name                      String
  slug                      String                      @unique
  description               String?
  type                      TerritoryType
  tier                      TerritoryTier               @default(TIER_2_SOVEREIGN)
  maxMembers                Int?
  avatarUrl                 String?
  coverUrl                  String?
  primaryColor              String?                     @default("#D4AF37")
  isPublic                  Boolean                     @default(false)
  requireApproval           Boolean                     @default(true)
  parentId                  String?
  memberCount               Int                         @default(0)
  postCount                 Int                         @default(0)
  createdAt                 DateTime                    @default(now())
  updatedAt                 DateTime                    @updatedAt
  contentModerationSettings ContentModerationSettings?
  encryptionSettings        CommunityEncryption?
  feedCaches                TerritoryFeedCache[]
  geoBlocks                 GeoBlock[]
  parent                    Territory?                  @relation("TerritoryHierarchy", fields: [parentId], references: [id])
  children                  Territory[]                 @relation("TerritoryHierarchy")
  algorithmSettings         TerritoryAlgorithmSettings?
  outgoingConnections       TerritoryConnection[]       @relation("ConnectionFrom")
  incomingConnections       TerritoryConnection[]       @relation("ConnectionTo")
  members                   TerritoryMember[]
  moderationRules           TerritoryModerationRule[]
  posts                     TerritoryPost[]
  strikes                   TerritoryStrike[]

  @@index([type])
  @@index([tier])
  @@index([parentId])
  @@index([slug])
}

model TerritoryMember {
  id          String        @id @default(uuid())
  territoryId String
  userId      String
  role        TerritoryRole @default(MEMBER)
  joinedAt    DateTime      @default(now())
  invitedById String?
  isMuted     Boolean       @default(false)
  strikeCount Int           @default(0)
  territory   Territory     @relation(fields: [territoryId], references: [id], onDelete: Cascade)

  @@unique([territoryId, userId])
  @@index([userId])
  @@index([territoryId])
}

model TerritoryPost {
  id          String    @id @default(uuid())
  territoryId String
  postId      String
  sharedById  String
  createdAt   DateTime  @default(now())
  territory   Territory @relation(fields: [territoryId], references: [id], onDelete: Cascade)

  @@unique([territoryId, postId])
  @@index([territoryId])
}

model TerritoryConnection {
  id              String                  @id @default(uuid())
  fromTerritoryId String
  toTerritoryId   String
  type            TerritoryConnectionType @default(OBSERVED)
  shareContent    Boolean                 @default(false)
  shareMembers    Boolean                 @default(false)
  status          ConnectionStatus        @default(PENDING)
  requestedAt     DateTime                @default(now())
  approvedAt      DateTime?
  fromTerritory   Territory               @relation("ConnectionFrom", fields: [fromTerritoryId], references: [id], onDelete: Cascade)
  toTerritory     Territory               @relation("ConnectionTo", fields: [toTerritoryId], references: [id], onDelete: Cascade)

  @@unique([fromTerritoryId, toTerritoryId])
  @@index([fromTerritoryId])
  @@index([toTerritoryId])
}

model TerritoryAlgorithmSettings {
  id                   String            @id @default(uuid())
  territoryId          String            @unique
  recencyWeight        Int               @default(50)
  engagementWeight     Int               @default(30)
  familiarityWeight    Int               @default(60)
  noveltyWeight        Int               @default(20)
  contentSourceWeights Json?             // { "memberPosts": 40, "sharedLinks": 20, "externalRSS": 15, "crossCommunity": 10, "aiCurated": 15 }
  rankingSignals       Json?             // { "recency": 80, "engagement": 60, "personalConnections": 0, "contentQuality": 40, "diversity": 20 }
  safetyFilters        Json?             // { "blockExternalUrls": true, "aiModeration": true, "reputationThreshold": 4, "requireFactCheck": false }
  algorithmTemplate    AlgorithmTemplate @default(BALANCED)
  isCustomized         Boolean           @default(false)
  contentRatings       String[]          @default(["G", "PG", "PG13"])
  whoCanPost           PostPermission    @default(MEMBERS)
  whoCanComment        PostPermission    @default(MEMBERS)
  whoCanInvite         PostPermission    @default(ELDERS)
  allowCrossPosting    Boolean           @default(false)
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt
  territory            Territory         @relation(fields: [territoryId], references: [id], onDelete: Cascade)
}

model CommunityEncryption {
  id                String            @id @default(uuid())
  territoryId       String            @unique
  encryptionScheme  EncryptionScheme  @default(STANDARD)
  keyRotationPolicy KeyRotationPolicy @default(MONTHLY)
  publicKey         String?
  keyDerivationSalt String?
  mediaEncryption   Boolean           @default(false)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  territory         Territory         @relation(fields: [territoryId], references: [id], onDelete: Cascade)
}

model TerritoryFeedCache {
  id            String    @id @default(uuid())
  territoryId   String
  userId        String?   // null = community-wide feed
  feedSignature String    // Hash of algorithm settings
  cachedContent Json      // Array of post IDs + scores
  expiresAt     DateTime
  createdAt     DateTime  @default(now())
  territory     Territory @relation(fields: [territoryId], references: [id], onDelete: Cascade)

  @@unique([territoryId, userId, feedSignature])
  @@index([territoryId])
  @@index([expiresAt])
}

model TerritoryModerationRule {
  id          String     @id @default(uuid())
  territoryId String
  title       String
  description String
  type        RuleType
  keywords    String[]   @default([])
  action      RuleAction @default(FLAG)
  isActive    Boolean    @default(true)
  order       Int        @default(0)
  createdAt   DateTime   @default(now())
  territory   Territory  @relation(fields: [territoryId], references: [id], onDelete: Cascade)

  @@index([territoryId])
}

model TerritoryStrike {
  id          String    @id @default(uuid())
  territoryId String
  userId      String
  issuedById  String
  reason      String
  postId      String?
  expiresAt   DateTime?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  territory   Territory @relation(fields: [territoryId], references: [id], onDelete: Cascade)

  @@index([territoryId])
  @@index([userId])
}

model GeoBlock {
  id          String       @id @default(uuid())
  territoryId String?
  countryCode String
  countryName String
  reason      String?
  blockType   GeoBlockType @default(FULL)
  createdById String
  createdAt   DateTime     @default(now())
  expiresAt   DateTime?
  territory   Territory?   @relation(fields: [territoryId], references: [id], onDelete: Cascade)

  @@unique([territoryId, countryCode])
  @@index([countryCode])
  @@index([territoryId])
}

model ContentModerationSettings {
  id                      String    @id @default(uuid())
  territoryId             String    @unique
  explicitLanguageFilter  Boolean   @default(false)
  explicitMaterialsFilter Boolean   @default(false)
  aiModerationEnabled     Boolean   @default(true)
  aiSensitivity           Int       @default(50)
  blockedWords            String[]  @default([])
  flaggedWords            String[]  @default([])
  minContentRating        String    @default("G")
  maxContentRating        String    @default("PG13")
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  territory               Territory @relation(fields: [territoryId], references: [id], onDelete: Cascade)
}

model PlatformSecurityPolicy {
  id          String             @id @default(uuid())
  name        String             @unique
  description String?
  isActive    Boolean            @default(true)
  type        SecurityPolicyType
  config      Json               @default("{}")
  createdById String
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  @@index([type])
  @@index([isActive])
}

model BlockedIP {
  id          String      @id @default(uuid())
  ipAddress   String      @unique
  reason      String?
  threatLevel ThreatLevel @default(MEDIUM)
  source      String?
  createdById String?
  createdAt   DateTime    @default(now())
  expiresAt   DateTime?

  @@index([expiresAt])
}

model SecurityAuditLog {
  id          String      @id @default(uuid())
  action      String
  userId      String?
  ipAddress   String
  countryCode String?
  userAgent   String?
  details     Json?
  severity    ThreatLevel @default(LOW)
  createdAt   DateTime    @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@index([ipAddress])
}

model BulletinPost {
  id           String            @id @default(uuid())
  type         BulletinType
  title        String
  content      String
  mediaUrl     String?
  externalLink String?
  upvotes      Int               @default(0)
  downvotes    Int               @default(0)
  viewCount    Int               @default(0)
  category     BulletinCategory
  tags         String[]
  isPinned     Boolean           @default(false)
  isVerified   Boolean           @default(false)
  location     String?
  locationGeo  String?
  eventDate    DateTime?
  authorId     String
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  expiresAt    DateTime?
  comments     BulletinComment[]
  author       User              @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([type])
  @@index([category])
  @@index([authorId])
  @@index([createdAt])
  @@index([isPinned])
}

model BulletinComment {
  id         String       @id @default(uuid())
  content    String
  bulletinId String
  authorId   String
  createdAt  DateTime     @default(now())
  bulletin   BulletinPost @relation(fields: [bulletinId], references: [id], onDelete: Cascade)

  @@index([bulletinId])
  @@index([authorId])
  @@index([createdAt])
}

model BulletinVote {
  id         String   @id @default(uuid())
  bulletinId String
  userId     String
  isUpvote   Boolean
  createdAt  DateTime @default(now())

  @@unique([bulletinId, userId])
  @@index([bulletinId])
  @@index([userId])
}

model LiveStreamSuggestion {
  id            String           @id @default(uuid())
  platformType  StreamPlatform
  externalId    String
  embedUrl      String
  title         String
  thumbnailUrl  String?
  description   String?
  upvotes       Int              @default(0)
  downvotes     Int              @default(0)
  status        SuggestionStatus @default(PENDING)
  suggestedById String
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  suggestedBy   User             @relation(fields: [suggestedById], references: [id], onDelete: Cascade)
  votes         StreamVote[]

  @@index([status])
  @@index([platformType])
  @@index([suggestedById])
  @@index([createdAt])
}

model StreamVote {
  id           String               @id @default(uuid())
  suggestionId String
  userId       String
  isUpvote     Boolean
  createdAt    DateTime             @default(now())
  suggestion   LiveStreamSuggestion @relation(fields: [suggestionId], references: [id], onDelete: Cascade)

  @@unique([suggestionId, userId])
  @@index([suggestionId])
  @@index([userId])
}

model ConnectionRequest {
  id         String           @id @default(uuid())
  senderId   String
  receiverId String
  status     ConnectionStatus @default(PENDING)
  message    String?
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
  receiver   User             @relation("ReceivedConnectionRequests", fields: [receiverId], references: [id], onDelete: Cascade)
  sender     User             @relation("SentConnectionRequests", fields: [senderId], references: [id], onDelete: Cascade)

  @@unique([senderId, receiverId])
  @@index([senderId])
  @@index([receiverId])
  @@index([status])
}

model UserConnectionSettings {
  id          String  @id @default(uuid())
  userId      String  @unique
  autoApprove Boolean @default(false)
  user        User    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model UserPresence {
  id          String   @id @default(uuid())
  userId      String   @unique
  isOnline    Boolean  @default(true)
  lastSeenAt  DateTime @default(now())
  currentPage String?
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([isOnline])
  @@index([lastSeenAt])
}

model Subscription {
  id                   String             @id @default(uuid())
  userId               String             @unique
  stripeCustomerId     String?
  stripeSubscriptionId String?
  stripePriceId        String?
  status               SubscriptionStatus @default(INACTIVE)
  currentPeriodEnd     DateTime?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  user                 User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([stripeCustomerId])
  @@index([status])
}

model Report {
  id         String       @id @default(uuid())
  reporterId String
  targetId   String
  targetType ReportType
  reason     String
  status     ReportStatus @default(PENDING)
  notes      String?
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  reporter   User         @relation(fields: [reporterId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([targetType])
  @@index([createdAt])
}

model Topic {
  id            String         @id @default(uuid())
  slug          String         @unique
  name          String
  description   String?
  icon          String?
  color         String?
  postCount     Int            @default(0)
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  posts         PostTopic[]
  userInterests UserInterest[]

  @@index([slug])
  @@index([postCount])
}

model PostTopic {
  id      String @id @default(uuid())
  postId  String
  topicId String
  post    Post   @relation(fields: [postId], references: [id], onDelete: Cascade)
  topic   Topic  @relation(fields: [topicId], references: [id], onDelete: Cascade)

  @@unique([postId, topicId])
  @@index([postId])
  @@index([topicId])
}

model UserInterest {
  id        String        @id @default(uuid())
  userId    String
  topicId   String
  level     InterestLevel @default(INTERESTED)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  topic     Topic         @relation(fields: [topicId], references: [id], onDelete: Cascade)
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, topicId])
  @@index([userId])
  @@index([topicId])
  @@index([level])
}

model UserKeyBundle {
  id              String   @id @default(uuid())
  userId          String   @unique
  identityKey     String
  signedPreKey    String
  preKeySignature String
  oneTimePreKeys  String[]
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model ScheduledPost {
  id           String         @id @default(uuid())
  userId       String
  type         PostType
  caption      String?
  mediaUrl     String?
  thumbnailUrl String?
  communityId  String?
  topicIds     String[]
  scheduledFor DateTime
  status       ScheduleStatus @default(PENDING)
  createdAt    DateTime       @default(now())
  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([scheduledFor, status])
}

model UserFeedPreferences {
  id               String   @id @default(uuid())
  userId           String   @unique
  recencyWeight    Int      @default(50)
  engagementWeight Int      @default(50)
  followingRatio   Int      @default(70)
  contentTypes     Json     @default("{}")
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model NotificationPreferences {
  id             String  @id @default(uuid())
  userId         String  @unique
  pushEnabled    Boolean @default(true)
  emailDigest    String  @default("daily")
  quietHoursFrom String?
  quietHoursTo   String?
  quietTimezone  String?
  channels       Json    @default("{}")
  user           User    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model PushSubscription {
  id        String   @id @default(uuid())
  userId    String
  endpoint  String
  p256dh    String
  auth      String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model PostAnalytics {
  id         String   @id @default(uuid())
  postId     String
  views      Int      @default(0)
  likes      Int      @default(0)
  comments   Int      @default(0)
  shares     Int      @default(0)
  saves      Int      @default(0)
  avgViewSec Float    @default(0)
  date       DateTime @db.Date
  post       Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([postId, date])
  @@index([postId])
  @@index([date])
}

enum ProposalType {
  RULE_CHANGE
  MODERATOR_ELECTION
  BAN_APPEAL
  FEATURE_REQUEST
  POLICY_CHANGE
}

enum ProposalStatus {
  ACTIVE
  PASSED
  REJECTED
  EXPIRED
  WITHDRAWN
}

enum ScheduleStatus {
  PENDING
  PUBLISHED
  FAILED
  CANCELLED
}

enum Role {
  USER
  MODERATOR
  ADMIN
  SUPERADMIN
}

enum MomentType {
  IMAGE
  VIDEO
  TEXT
}

enum LiveStreamStatus {
  SCHEDULED
  LIVE
  ENDED
  CANCELLED
}

enum ChatType {
  MESSAGE
  GIFT
  REACTION
  JOIN
  LEAVE
}

enum PostType {
  IMAGE
  VIDEO
  TEXT
  POLL
  RALLY
}

enum RSVPStatus {
  IN
  MAYBE
  OUT
}

enum CommunityRole {
  MEMBER
  MODERATOR
  ADMIN
}

enum MessageMedia {
  IMAGE
  VIDEO
  AUDIO
  FILE
}

enum NotificationType {
  LIKE
  COMMENT
  FOLLOW
  MENTION
  COMMUNITY_INVITE
  COMMUNITY_POST
  MESSAGE
  SYSTEM
  WAVE
  CALL
  POLL
}

enum MigrationPlatform {
  INSTAGRAM
  TIKTOK
  TWITTER
  FACEBOOK
  WHATSAPP
}

enum MigrationStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum ImportStatus {
  PENDING
  IMPORTING
  COMPLETED
  SKIPPED
  FAILED
}

enum ConnectionType {
  FOLLOWER
  FOLLOWING
  MUTUAL
  CONTACT
}

enum InviteStatus {
  NOT_SENT
  SENT
  REMINDED
  OPENED
  JOINED
  DECLINED
  BOUNCED
}

enum InviteMethod {
  EMAIL
  SMS
  LINK
}

enum TerritoryType {
  CIRCLE
  CLAN
  TRIBE
  NATION
  WORLD
}

enum TerritoryRole {
  MEMBER
  GUARDIAN
  ELDER
  CHIEF
}

enum TerritoryConnectionType {
  ALLIED
  FEDERATED
  OBSERVED
  BLOCKED
}

enum ConnectionStatus {
  PENDING
  APPROVED
  REJECTED
  ACCEPTED
  DECLINED
  BLOCKED
}

enum PostPermission {
  ANYONE
  MEMBERS
  GUARDIANS
  ELDERS
  CHIEFS
}

enum RuleType {
  KEYWORD_FILTER
  CONTENT_RATING
  SPAM_DETECTION
  CUSTOM
}

enum RuleAction {
  FLAG
  HIDE
  DELETE
  WARN
  STRIKE
}

enum GeoBlockType {
  FULL
  VIEW_ONLY
  NO_JOIN
}

enum SecurityPolicyType {
  RATE_LIMITING
  IP_BLOCKING
  GEO_RESTRICTION
  CONTENT_SCANNING
  AUTH_HARDENING
  DATA_PROTECTION
  THREAT_DETECTION
}

enum ThreatLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum BulletinType {
  ANNOUNCEMENT
  JOB
  COLLABORATION
  INVESTMENT
  EVENT
  CALL_TO_ACTION
  SPOTLIGHT
  DISCUSSION
}

enum BulletinCategory {
  SOCIAL_JUSTICE
  CAREER
  BUSINESS
  COMMUNITY
  CULTURE
  TECH
  ACTIVISM
  GENERAL
}

enum StreamPlatform {
  YOUTUBE
  TWITCH
  FACEBOOK
  INSTAGRAM
  TIKTOK
  NATIVE
}

enum SuggestionStatus {
  PENDING
  APPROVED
  LIVE
  ENDED
  REJECTED
}

enum SubscriptionStatus {
  active
  canceled
  incomplete
  incomplete_expired
  past_due
  paused
  trialing
  unpaid
  INACTIVE
}

enum ReportType {
  POST
  USER
  COMMENT
  COMMUNITY
  LIVESTREAM
  MESSAGE
}

enum ReportStatus {
  PENDING
  REVIEWING
  RESOLVED
  DISMISSED
}

enum InterestLevel {
  NOT_INTERESTED
  INTERESTED
  VERY_INTERESTED
}

enum TerritoryTier {
  TIER_1_PERSONAL    // 5-50 members, E2E encryption
  TIER_2_SOVEREIGN   // 50-10K members, custom algorithms
  TIER_3_FEDERATED   // 10K+ members, dedicated infrastructure
}

enum EncryptionScheme {
  NONE
  STANDARD
  SIGNAL_PROTOCOL
  PGP
}

enum KeyRotationPolicy {
  DAILY
  WEEKLY
  MONTHLY
  NEVER
}

enum AlgorithmTemplate {
  CHRONOLOGICAL   // Pure time-based
  FAMILY_FEED     // Family-optimized
  ACTIVIST        // Activism-focused
  NEWS_HUB        // News/credibility priority
  BALANCED        // Default balanced
  CUSTOM          // Fully custom
}

// ============================================
// DEVELOPER PLATFORM
// ============================================
model DeveloperApp {
  id            String   @id @default(uuid())
  ownerId       String
  name          String
  slug          String   @unique
  description   String?
  websiteUrl    String?
  callbackUrl   String?               // OAuth2 redirect URI
  logoUrl       String?
  clientId      String   @unique @default(uuid())
  clientSecret  String                 // Hashed
  scopes        String   @default("read")  // Comma-separated: read,write,communities,messages,calls
  isApproved    Boolean  @default(true)    // Auto-approve for now
  isActive      Boolean  @default(true)
  rateLimitTier String   @default("free")  // free, pro, enterprise
  requestCount  Int      @default(0)
  lastUsedAt    DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  apiKeys       ApiKey[]
  webhooks      Webhook[]
  oauthTokens   OAuthToken[]

  @@index([ownerId])
  @@index([clientId])
}

model ApiKey {
  id           String   @id @default(uuid())
  appId        String
  name         String   @default("Default")
  keyHash      String   @unique           // SHA-256 of the key (never store raw)
  keyPrefix    String                      // First 8 chars for identification
  scopes       String   @default("read")
  isActive     Boolean  @default(true)
  expiresAt    DateTime?
  lastUsedAt   DateTime?
  requestCount Int      @default(0)
  createdAt    DateTime @default(now())
  app          DeveloperApp @relation(fields: [appId], references: [id], onDelete: Cascade)

  @@index([appId])
  @@index([keyHash])
}

model OAuthToken {
  id            String   @id @default(uuid())
  appId         String
  userId        String
  accessToken   String   @unique
  refreshToken  String?  @unique
  scopes        String
  expiresAt     DateTime
  createdAt     DateTime @default(now())
  app           DeveloperApp @relation(fields: [appId], references: [id], onDelete: Cascade)

  @@index([appId])
  @@index([userId])
  @@index([accessToken])
}

model Webhook {
  id          String   @id @default(uuid())
  appId       String
  url         String
  secret      String               // For HMAC signature verification
  events      String               // Comma-separated: post.created, member.joined, etc.
  isActive    Boolean  @default(true)
  failCount   Int      @default(0)
  lastFiredAt DateTime?
  createdAt   DateTime @default(now())
  app         DeveloperApp @relation(fields: [appId], references: [id], onDelete: Cascade)

  @@index([appId])
}

model WebhookLog {
  id         String   @id @default(uuid())
  webhookId  String
  event      String
  payload    String               // JSON stringified
  statusCode Int?
  response   String?
  success    Boolean  @default(false)
  firedAt    DateTime @default(now())

  @@index([webhookId])
  @@index([firedAt])
}

// ============================================
// EARLY ACCESS & INVITE CODES
// ============================================

model EarlyAccessRequest {
  id          String   @id @default(uuid())
  name        String
  email       String   @unique
  reason      String   @db.Text      // Why they want to join
  role        String?                 // What they do (developer, community builder, etc.)
  socialUrl   String?                 // Optional social media link
  status      String   @default("pending") // pending | approved | rejected
  accessCode  String?  @unique       // Generated when approved
  createdAt   DateTime @default(now())
  reviewedAt  DateTime?

  @@index([status])
  @@index([email])
}

model AccessCode {
  id          String    @id @default(uuid())
  code        String    @unique
  type        String    @default("early_access") // early_access | founder_invite | admin
  maxUses     Int       @default(1)
  useCount    Int       @default(0)
  expiresAt   DateTime?
  createdById String?
  createdAt   DateTime  @default(now())
  isActive    Boolean   @default(true)

  @@index([code])
  @@index([isActive])
}
